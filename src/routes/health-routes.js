/*
 * © 2026 Heady Systems LLC.
 * PROPRIETARY AND CONFIDENTIAL.
 * Unauthorized copying, modification, or distribution is strictly prohibited.
 */
/**
 * Heady Health Routes — Production health and readiness endpoints
 * Provides /health/live, /health/ready, and /health/full for Kubernetes-style probes.
 */
const express = require('express');
const router = express.Router();

const startTime = Date.now();

function getUptimeSeconds() {
    return Math.floor((Date.now() - startTime) / 1000);
}

function buildLiveHealth() {
    return {
        status: 'ok',
        uptime: getUptimeSeconds(),
        timestamp: new Date().toISOString(),
    };
}

// ── Liveness: is the process alive? ─────────────────────────────────
function handleLive(req, res) {
    res.json(buildLiveHealth());
}
router.get('/live', handleLive);

// ── Readiness: can we serve traffic? ────────────────────────────────
router.get('/ready', async (req, res) => {
    const checks = {};
    let allReady = true;

    // Check resilience module
    try {
        const resilience = require('../resilience');
        const status = resilience.getResilienceStatus();
        checks.resilience = {
            status: 'ok',
            breakers: status.summary.breakersRegistered,
            openBreakers: status.summary.breakersOpen,
        };
        if (status.summary.breakersOpen > 3) {
            checks.resilience.status = 'degraded';
            allReady = false;
        }
    } catch {
        checks.resilience = { status: 'unavailable' };
    }

    // Check filesystem
    try {
        const fs = require('fs');
        fs.accessSync('/home/headyme/Heady/heady-registry.json', fs.constants.R_OK);
        checks.filesystem = { status: 'ok' };
    } catch {
        checks.filesystem = { status: 'error' };
        allReady = false;
    }

    // Check memory
    const mem = process.memoryUsage();
    const heapUsedMB = Math.round(mem.heapUsed / 1024 / 1024);
    const heapTotalMB = Math.round(mem.heapTotal / 1024 / 1024);
    checks.memory = {
        status: heapUsedMB > 450 ? 'warning' : 'ok',
        heapUsedMB,
        heapTotalMB,
        rss: Math.round(mem.rss / 1024 / 1024) + 'MB',
    };

    // Check event loop lag
    const lagStart = Date.now();
    await new Promise(r => setImmediate(r));
    const lagMs = Date.now() - lagStart;
    checks.eventLoop = {
        status: lagMs > 100 ? 'warning' : 'ok',
        lagMs,
    };

    res.status(allReady ? 200 : 503).json({
        status: allReady ? 'ready' : 'not_ready',
        checks,
        uptime: getUptimeSeconds(),
        timestamp: new Date().toISOString(),
    });
});

// ── Full: comprehensive system status ───────────────────────────────
router.get('/full', async (req, res) => {
    const pkg = (() => { try { return require('../../package.json'); } catch { return {}; } })();

    let resilienceStatus = null;
    try {
        resilienceStatus = require('../resilience').getResilienceStatus();
    } catch { /* ignore */ }

    res.json({
        service: 'heady-manager',
        version: pkg.version || 'unknown',
        environment: process.env.NODE_ENV || 'development',
        uptime: getUptimeSeconds(),
        node: process.version,
        platform: process.platform,
        arch: process.arch,
        pid: process.pid,
        memory: process.memoryUsage(),
        cpu: process.cpuUsage(),
        resilience: resilienceStatus?.summary || null,
        timestamp: new Date().toISOString(),
    });
});

module.exports = {
    router,
    buildLiveHealth,
    handleLive,
};
