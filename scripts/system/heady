#!/bin/bash

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘  HEADY â€” Unified Command Interface                               â•‘
# â•‘  Routes 100% of all Heady services at optimal concentration      â•‘
# â•‘  HCFP Auto-Success Mode: DEFAULT                                 â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# â”€â”€ Configuration â”€â”€
HEADY_MANAGER_URL="${HEADY_MANAGER_URL:-https://manager.headysystems.com}"
HEADY_BRAIN_URL="${HEADY_BRAIN_URL:-${HEADY_MANAGER_URL}}"
HEADY_API_KEY="${HEADY_API_KEY:-heady_api_key_001}"
CLOUDFLARE_API_TOKEN="${CLOUDFLARE_API_TOKEN:-VGNo4jwin3V6eFO0HpGGYUyn2iWFM6JpkPfdIqUa}"
CLOUDFLARE_ACCOUNT_ID="${CLOUDFLARE_ACCOUNT_ID:-8b1fa38f282c691423c6399247d53323}"

log()     { echo -e "${CYAN}[HEADY]${NC} $1"; }
success() { echo -e "${GREEN}[âœ… HEADY]${NC} $1"; }
warn()    { echo -e "${YELLOW}[âš ï¸  HEADY]${NC} $1"; }
error()   { echo -e "${RED}[âŒ HEADY]${NC} $1"; }
status()  { echo -e "${MAGENTA}[ðŸ”® HEADY]${NC} $1"; }

# â”€â”€ Engage All Services â”€â”€
engage_services() {
    local task_description="$1"
    
    status "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    status "  HCFP AUTO-SUCCESS // 100% RESOURCE ALLOCATION"
    status "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    log "Task: ${task_description}"
    echo ""
    
    # Health check all services
    log "Engaging Heady services..."
    
    # HeadyBrain
    local brain_status=$(curl -s -o /dev/null -w "%{http_code}" "${HEADY_MANAGER_URL}/api/brain/health" 2>/dev/null || echo "000")
    if [ "$brain_status" = "200" ]; then
        success "HeadyBrain â”€â”€ ACTIVE (${HEADY_MANAGER_URL})"
    else
        warn "HeadyBrain â”€â”€ DEGRADED (status: ${brain_status})"
    fi
    
    # HeadyBattle
    local battle_status=$(curl -s "${HEADY_MANAGER_URL}/health" 2>/dev/null | grep -o '"HeadyBattle_engine":"[^"]*"' | cut -d'"' -f4 || echo "UNKNOWN")
    if [ "$battle_status" = "ACTIVE" ]; then
        success "HeadyBattle â”€â”€ ACTIVE (adversarial review engaged)"
    else
        warn "HeadyBattle â”€â”€ ${battle_status}"
    fi
    
    # HeadySoul
    local soul_status=$(curl -s "${HEADY_MANAGER_URL}/health" 2>/dev/null | grep -o '"headysoul":"[^"]*"' | cut -d'"' -f4 || echo "UNKNOWN")
    if [ "$soul_status" = "ACTIVE" ]; then
        success "HeadySoul â”€â”€ ACTIVE (ethical oversight engaged)"
    else
        warn "HeadySoul â”€â”€ ${soul_status}"
    fi
    
    # HCFP
    success "HCFP â”€â”€ ENFORCED (auto-success mode)"
    
    # Cloudflare
    if [ -n "$CLOUDFLARE_API_TOKEN" ] && [ "$CLOUDFLARE_API_TOKEN" != "your_api_token" ]; then
        success "Cloudflare â”€â”€ READY (Pages + Workers + DNS)"
    else
        warn "Cloudflare â”€â”€ NO TOKEN"
    fi
    
    echo ""
    status "All resources concentrated on task. Executing..."
    echo ""
}

# â”€â”€ Deploy a Heady site â”€â”€
heady_deploy() {
    local target="${1:-}"
    local project_dir=""
    local project_name=""
    
    case "$target" in
        headyweb|HeadyWeb)
            project_dir="$HOME/CascadeProjects/HeadyWeb"
            project_name="headyweb"
            ;;
        headysystems|HeadySystems)
            project_dir="$HOME/headysystems"
            project_name="heady-systems"
            ;;
        headybuddy|HeadyBuddy)
            project_dir="$HOME/headybuddy"
            project_name="headybuddy"
            ;;
        headyme|HeadyMe)
            project_dir="$HOME/headyme"
            project_name="headyme"
            ;;
        headyio|HeadyIO)
            project_dir="$HOME/headyio"
            project_name="headyio"
            ;;
        headyconnection|HeadyConnection)
            project_dir="$HOME/headyconnection"
            project_name="headyconnection"
            ;;
        headymcp|HeadyMCP)
            project_dir="$HOME/headymcp"
            project_name="headymcp"
            ;;
        all)
            for site in headyweb headysystems headybuddy headyme headyio headyconnection headymcp; do
                heady_deploy "$site"
            done
            return
            ;;
        *)
            error "Unknown target: $target"
            log "Available: headyweb, headysystems, headybuddy, headyme, headyio, headyconnection, headymcp, all"
            return 1
            ;;
    esac
    
    log "Building ${target}..."
    cd "$project_dir"
    
    if [ -f "package.json" ]; then
        npm run build 2>&1 | tail -5
    fi
    
    if [ -d "dist" ]; then
        log "Deploying ${target} to Cloudflare Pages..."
        CLOUDFLARE_API_TOKEN="$CLOUDFLARE_API_TOKEN" \
        CLOUDFLARE_ACCOUNT_ID="$CLOUDFLARE_ACCOUNT_ID" \
        npx wrangler pages deploy dist \
            --project-name "$project_name" \
            --branch main \
            --commit-dirty=true 2>&1 | tail -5
        success "Deployed ${target}!"
    else
        error "No dist/ directory in ${project_dir}"
    fi
}

# â”€â”€ Build a project â”€â”€
heady_build() {
    local target="${1:-}"
    local project_dir=""
    
    case "$target" in
        headyweb|HeadyWeb) project_dir="$HOME/CascadeProjects/HeadyWeb" ;;
        headysystems|HeadySystems) project_dir="$HOME/headysystems" ;;
        headybuddy|HeadyBuddy) project_dir="$HOME/headybuddy" ;;
        *) error "Unknown target: $target"; return 1 ;;
    esac
    
    log "Building ${target}..."
    cd "$project_dir" && npm run build 2>&1
    success "Build complete for ${target}!"
}

# â”€â”€ Health check â”€â”€
heady_health() {
    log "Running full ecosystem health check..."
    echo ""
    
    curl -s "${HEADY_MANAGER_URL}/health" 2>/dev/null | python3 -m json.tool 2>/dev/null || warn "Manager health endpoint unavailable"
    echo ""
    
    # Check all websites
    for site in headysystems.com headyme.com headybuddy.org headymcp.com headyio.com headyconnection.org; do
        local code=$(curl -s -o /dev/null -w "%{http_code}" "https://${site}" 2>/dev/null || echo "000")
        if [ "$code" = "200" ]; then
            success "${site} â”€â”€ ${code}"
        else
            warn "${site} â”€â”€ ${code}"
        fi
    done
}

# â”€â”€ Scan for issues â”€â”€
heady_scan() {
    local target="${1:-all}"
    log "Scanning ${target} for issues..."
    
    # Check for localhost leaks
    local localhost_count=$(grep -rn "localhost" "$HOME/headysystems/" "$HOME/headybuddy/" "$HOME/headyme/" --include="*.js" --include="*.html" 2>/dev/null | grep -v node_modules | grep -v ".git" | wc -l)
    if [ "$localhost_count" -gt 0 ]; then
        warn "Found ${localhost_count} localhost references"
    else
        success "Zero localhost violations"
    fi
    
    # Check for Ollama references
    local ollama_count=$(grep -rn "ollama\|OLLAMA" "$HOME/headysystems/" "$HOME/headybuddy/" "$HOME/headyme/" "$HOME/CascadeProjects/Heady/src/" --include="*.js" --include="*.html" 2>/dev/null | grep -v node_modules | grep -v ".git" | wc -l)
    if [ "$ollama_count" -gt 0 ]; then
        warn "Found ${ollama_count} Ollama references (should be Heady Brain)"
    else
        success "Zero Ollama violations â€” all routed through Heady Brain"
    fi
    
    success "Scan complete"
}

# â”€â”€ Main Entry Point â”€â”€
main() {
    local command="${1:-help}"
    shift || true
    
    # Always engage all services at 100% concentration
    engage_services "$command $*"
    
    case "$command" in
        deploy)     heady_deploy "$@" ;;
        build)      heady_build "$@" ;;
        health)     heady_health "$@" ;;
        scan)       heady_scan "$@" ;;
        auto-success|hcfp)
            # Pass through to HCFP auto-success
            local task_desc="$*"
            if [ -f "$HOME/CascadeProjects/Heady/scripts/hcfp/hcfp-auto-success.sh" ]; then
                cd "$HOME/CascadeProjects/Heady" && bash "scripts/hcfp/hcfp-auto-success.sh" "$@"
            else
                log "HCFP auto-success: ${task_desc}"
                log "All services engaged. Execute task through Heady ecosystem."
            fi
            ;;
        help|--help|-h)
            echo ""
            echo -e "${WHITE}HeadyWeb â€” Unified Command Interface${NC}"
            echo -e "${CYAN}HCFP Auto-Success Mode: ALWAYS ON${NC}"
            echo ""
            echo "Usage: heady <command> [args...]"
            echo ""
            echo "Commands:"
            echo "  deploy <target>   Build and deploy (headyweb, headysystems, headybuddy, all, ...)"
            echo "  build <target>    Build a project"
            echo "  health            Full ecosystem health check"
            echo "  scan [target]     Scan for issues (localhost, Ollama leaks, etc.)"
            echo "  auto-success      Run HCFP auto-success pipeline"
            echo "  help              Show this help"
            echo ""
            echo "Every command automatically engages 100% of Heady services:"
            echo "  HeadyBrain, HeadyBattle, HeadySoul, HCFP, Cloudflare"
            echo ""
            ;;
        *)
            # Unknown command â€” still engage services and log
            log "Custom task: ${command} $*"
            log "All services at 100%. Ready for task execution."
            ;;
    esac
    
    echo ""
    success "Task complete."
}

main "$@"
